name: Sync Dictionaries

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight UTC
  workflow_dispatch: # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Download latest zhwiki.dict.yaml
      id: download_zhwiki
      uses: robinraju/release-downloader@v1.10
      with:
        repository: 'felixonmars/fcitx5-pinyin-zhwiki'
        latest: true
        fileName: '*.dict.yaml'
        out-file-path: '/home/runner/work/rime-dictionaries/rime-dictionaries'

    - name: Check downloaded files output
      run: |
        echo "Downloaded files: ${{ steps.download_zhwiki.outputs.downloaded_files }}"
        
    - name: Use downloaded file name
      run: |
        # Get comma-separated file path string
        downloaded_files="${{ steps.download_zhwiki.outputs.downloaded_files }}"
        # Split file paths by comma and select the latest file
        latest_file=$(echo $downloaded_files | tr ',' '\n' | sort -r | head -n 1 | tr -d '[]' | xargs)
        echo "Latest file is: $latest_file"
        echo "LATEST_FILE=$latest_file" >> $GITHUB_ENV
        
    - name: Rename zhwiki.dict.yaml
      run: |
        mv "$LATEST_FILE" zhwiki.dict.yaml
        
    - name: Sync specific files from rime-ice
      run: |
        git clone https://github.com/iDvel/rime-ice.git
        mkdir -p cn_dicts
        cp rime-ice/cn_dicts/base.dict.yaml cn_dicts/
        cp rime-ice/cn_dicts/ext.dict.yaml cn_dicts/
        cp rime-ice/cn_dicts/tencent.dict.yaml cn_dicts/
        mv zhwiki.dict.yaml cn_dicts/
        rm -rf rime-ice
        rm -f zhwiki*.dict.yaml web-slang*.dict.yaml
        git add cn_dicts/base.dict.yaml cn_dicts/ext.dict.yaml cn_dicts/tencent.dict.yaml

    - name: Sync luna dict
      run: |
        git clone https://github.com/rime/rime-luna-pinyin.git
        cp  rime-luna-pinyin/luna_pinyin.dict.yaml cn_dicts/
        rm -rf rime-luna-pinyin
        git add cn_dicts/luna_pinyin.dict.yaml

    - name: Update version in bdim.dict.yaml
      run: |
          sed -i "s/version: \"[0-9]\{8\}\"/version: \"$(date +%Y%m%d)\"/" bdim.dict.yaml
          git add bdim.dict.yaml
        
    - name: Commit changes
      run: |
        git config --global user.name "bdim404"
        git config --global user.email "i@bdim.moe"
        git add .
        git status
        git commit -m "Sync latest dictionaries" || echo "No changes to commit"

    - name: Push changes
      env:
        GITHUB_TOKEN: ${{ secrets.PAT }}
      run: |
        git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/bdim404/rime-dictionaries.git
        git push origin main

    - name: Package dictionaries into a tar file
      run: |
        mkdir -p rime
        cp default.custom.yaml luna_pinyin.custom.yaml bdim.dict.yaml rime/
        cp -r cn_dicts/ rime/
        tar -czf rime-dictionaries.tar.gz -C rime .
        
    - name: Create tag and upload to GitHub Releases
      run: |
        # Create tag
        TAG_NAME="release-$(date +%Y%m%d)"
        echo "Created tag name: $TAG_NAME"  # Output tag name for debugging
        git tag "$TAG_NAME"
        git push origin "$TAG_NAME"

        # Upload to GitHub Releases
        echo "Uploading to GitHub Releases with tag: $TAG_NAME"
        gh release create "$TAG_NAME" rime-dictionaries.tar.gz --title "Automated Release $(date +%Y%m%d)" --notes "Automated release created on $(date)"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up old releases
      run: |
        # Get all release tags sorted by date (newest first)
        ALL_TAGS=$(git tag -l 'release-*' | sort -r)

        # Count total releases
        TOTAL_COUNT=$(echo "$ALL_TAGS" | wc -l)

        # If we have more than 10 releases, delete the old ones
        if [ "$TOTAL_COUNT" -gt 10 ]; then
          # Get tags to delete (skip first 10, delete the rest)
          TAGS_TO_DELETE=$(echo "$ALL_TAGS" | tail -n +11)

          echo "Total releases: $TOTAL_COUNT"
          echo "Keeping latest 10, deleting $((TOTAL_COUNT - 10)) old releases"

          # Delete each old release and its tag
          for TAG in $TAGS_TO_DELETE; do
            echo "Deleting release and tag: $TAG"
            # Delete the release (ignore errors if release doesn't exist)
            gh release delete "$TAG" --yes 2>/dev/null || true
            # Delete the tag from remote
            git push origin --delete "$TAG" 2>/dev/null || true
            # Delete local tag
            git tag -d "$TAG" 2>/dev/null || true
          done

          echo "Cleanup complete. Kept 10 most recent releases."
        else
          echo "Currently have $TOTAL_COUNT releases. No cleanup needed (keeping all, threshold is 10)."
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
