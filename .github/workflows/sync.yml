name: Sync Dictionaries

on:
  schedule:
    - cron: '0 0 * * *' # 每天运行一次
  workflow_dispatch: # 手动触发

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Download latest zhwiki.dict.yaml
      id: download_zhwiki
      uses: robinraju/release-downloader@v1.10
      with:
        repository: 'felixonmars/fcitx5-pinyin-zhwiki'
        latest: true
        fileName: '*.dict.yaml'
        out-file-path: '/home/runner/work/rime-dictionaries/rime-dictionaries'

    - name: Check downloaded files output
      run: |
        echo "Downloaded files: ${{ steps.download_zhwiki.outputs.downloaded_files }}"
        
    - name: Use downloaded file name
      run: |
        # 获取以逗号分隔的文件路径字符串
        downloaded_files="${{ steps.download_zhwiki.outputs.downloaded_files }}"
        # 将文件路径按逗号分割，并选择最新的文件
        latest_file=$(echo $downloaded_files | tr ',' '\n' | sort -r | head -n 1 | tr -d '[]' | xargs)
        echo "Latest file is: $latest_file"
        echo "LATEST_FILE=$latest_file" >> $GITHUB_ENV
        
    - name: Rename zhwiki.dict.yaml
      run: |
        mv "$LATEST_FILE" zhwiki.dict.yaml
        
    - name: Sync specific files from rime-ice
      run: |
        git clone https://github.com/iDvel/rime-ice.git
        mkdir -p cn_dicts
        cp rime-ice/cn_dicts/base.dict.yaml cn_dicts/
        cp rime-ice/cn_dicts/ext.dict.yaml cn_dicts/
        cp rime-ice/cn_dicts/tencent.dict.yaml cn_dicts/
        cp zhwiki.dict.yaml cn_dicts/
        rm -rf rime-ice
        git add cn_dicts/base.dict.yaml cn_dicts/ext.dict.yaml cn_dicts/tencent.dict.yaml cn_dicts/zhwiki.dict.yaml

    - name: Sync luna dict
      run: |
        git clone https://github.com/rime/rime-luna-pinyin.git
        cp  rime-luna-pinyin/luna_pinyin.dict.yaml cn_dicts/
        rm -rf rime-luna-pinyin
        git add cn_dicts/luna_pinyin.dict.yaml

    - name: Update version in personal.dict.yaml
      run: |
          sed -i "s/version: \"[0-9]\{8\}\"/version: \"$(date +%Y%m%d)\"/" personal.dict.yaml
          git add personal.dict.yaml
        
    - name: Commit changes
      run: |
        git config --global user.name "bdim404"
        git config --global user.email "i@bdim.moe"
        git add .
        git status
        git commit -m "Sync latest dictionaries" || echo "No changes to commit"

    - name: Push changes
      env:
        GITHUB_TOKEN: ${{ secrets.PAT }}
      run: |
        git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/bdim404/rime-dictionaries.git
        git push origin main

    - name: Package dictionaries into a tar file
      run: |
        mkdir -p rime
        cp default.custom.yaml luna_pinyin.custom.yaml personal.dict.yaml rime/
        cp -r cn_dicts/ rime/
        tar -czf rime-dictionaries.tar.gz -C rime .
        
    - name: Create a new tag
      run: |
        # 创建一个标签，使用当前日期或其他唯一标识
        TAG_NAME="release-$(date +%Y%m%d%H%M)"
        echo "Created tag name: $TAG_NAME"  # 输出标签名称，用于调试
        if [ -z "$TAG_NAME" ]; then echo "TAG_NAME is empty!"; exit 1; fi  # 检查标签名称是否为空
        git tag "$TAG_NAME"
        git push origin "$TAG_NAME"

    - name: Checkout the new tag
      run: |
        # 打印 TAG_NAME 变量，确保它不为空
        echo "Checking out tag: $TAG_NAME"
        if [ -z "$TAG_NAME" ]; then echo "TAG_NAME is empty!"; exit 1; fi  # 检查标签名称是否为空
        git checkout "$TAG_NAME"

    - name: Upload to GitHub Releases
      uses: softprops/action-gh-release@v1
      with:
        files: rime-dictionaries.tar.gz
        token: ${{ secrets.GITHUB_TOKEN }}
      env:
        LATEST_FILE: /home/runner/work/rime-dictionaries/rime-dictionaries/zhwiki-20240509.dict.yaml
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
